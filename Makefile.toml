# cargo-make tasks for nix-bench
# Run: cargo make <task>

[config]
default_to_workspace = false

# ============================================================================
# Build
# ============================================================================

[tasks.agent]
description = "Build agents for x86_64 and aarch64 (statically linked with musl)"
command = "cargo"
args = [
    "build",
    "-p", "nix-bench-agent",
    "--release",
    "--target", "x86_64-unknown-linux-musl",
    "--target", "aarch64-unknown-linux-musl",
]

[tasks.build]
description = "Build agents and coordinator in parallel"
run_task = { name = ["agent", "build-coordinator"], parallel = true }

[tasks.build-coordinator]
description = "Build coordinator in release mode"
private = true
command = "cargo"
args = ["build", "-p", "nix-bench-coordinator", "--release"]

# ============================================================================
# Run
# ============================================================================

[tasks.run]
description = "Build all, then run coordinator with 'run' subcommand (pass args after --)"
dependencies = ["build"]
command = "./target/release/nix-bench-coordinator"
args = ["run", "${@}"]

[tasks.coord]
description = "Build coordinator, run any subcommand (pass args after --)"
dependencies = ["build-coordinator"]
command = "./target/release/nix-bench-coordinator"
args = ["${@}"]

# ============================================================================
# Test
# ============================================================================

[tasks.test]
description = "Run tests with nextest"
command = "cargo"
args = ["nextest", "run"]

[tasks.test-all]
description = "Run all tests including AWS integration"
command = "cargo"
args = ["nextest", "run", "--run-ignored", "all"]

[tasks.e2e]
description = "Build agents then run full E2E test"
dependencies = ["agent"]
command = "cargo"
args = ["test", "--test", "agent_e2e_integration", "--", "--ignored", "--nocapture"]
