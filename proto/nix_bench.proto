syntax = "proto3";
package nix_bench;

service LogStream {
  rpc StreamLogs(StreamLogsRequest) returns (stream LogEntry);
  rpc GetStatus(StatusRequest) returns (StatusResponse);
}

// Canonical status codes for agent/coordinator communication
enum StatusCode {
  STATUS_CODE_PENDING = 0;   // Not yet started
  STATUS_CODE_RUNNING = 1;   // Currently running
  STATUS_CODE_COMPLETE = 2;  // Successfully completed
  STATUS_CODE_FAILED = 3;    // Failed with error (changed from -1 to 3)
  STATUS_CODE_BOOTSTRAP = 4; // Bootstrap phase (setting up environment)
  STATUS_CODE_WARMUP = 5;    // Warmup phase (cache warming build)
}

message StreamLogsRequest {
  string instance_type = 1;
  string run_id = 2;
}

message LogEntry {
  int64 timestamp = 1;
  string message = 2;  // Combined stdout+stderr (like terminal)
}

message StatusRequest {}

// Result of a single benchmark run
message RunResult {
  uint32 run_number = 1;      // Run slot number (1-based)
  double duration_secs = 2;   // Duration in seconds
  bool success = 3;           // Whether the run succeeded
}

message StatusResponse {
  StatusCode status_code = 1; // Canonical status code
  uint32 run_progress = 2;
  uint32 total_runs = 3;
  // Total number of log messages dropped due to slow client consumption
  uint64 dropped_log_count = 4;
  // Build durations in seconds for completed runs (deprecated: use run_results)
  repeated double durations = 5;
  // Detailed results per run with success/failure status
  repeated RunResult run_results = 6;
  // Nix attribute that was built (e.g., "shallow.hello")
  string attr = 7;
  // System architecture (e.g., "x86_64-linux", "aarch64-linux")
  string system = 8;
}
